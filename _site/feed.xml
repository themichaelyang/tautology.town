<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Your awesome title</title>
    <description>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
</description>
    <link>http://localhost:4000/</link>
    <atom:link href="http://localhost:4000/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Mon, 17 Nov 2025 12:11:43 -0800</pubDate>
    <lastBuildDate>Mon, 17 Nov 2025 12:11:43 -0800</lastBuildDate>
    <generator>Jekyll v4.3.4</generator>
    
      <item>
        <title>Learning about: OAuth 2.0 authorization code grants</title>
        <description>&lt;p&gt;Over the weekend, I learned how to integrate a client app with OAuth 2.0 to add “login with” functionality. Here’s how I understand it.&lt;/p&gt;

&lt;h2 id=&quot;basic-flow-for-a-web-app-with-a-backend&quot;&gt;Basic flow for a web app with a backend&lt;/h2&gt;

&lt;p&gt;You have your app server, the OAuth client, and the service you want to log in with, the authorization server.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;You register your app server and its redirect URI with the authorization server, and are given a client ID and client secret.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;When a user goes to “login with”, your app server redirects them to the authorization server’s &lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749#section-3.1&quot;&gt;authorization endpoint&lt;/a&gt;, typically at &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/oauth/authorize&lt;/code&gt;. Parameters are sent as query parameters to the authorization endpoint, including the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;client_id&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;redirect_uri&lt;/code&gt;. This endpoint is where the authorization service first asks for login then shows a page asking the user if they want to grant permissions to your app server.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;If authorized, the authorization service redirects back to your app server at the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;redirect_uri&lt;/code&gt;, with a query parameter &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;code&lt;/code&gt; for the authorization code.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Your app server now exchanges the authorization code for an access token by making a POST request to the authorization server’s &lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749#section-3.2&quot;&gt;token endpoint&lt;/a&gt;, typically &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/oauth/token&lt;/code&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Now, your app server has an API access token to the authorization server. You can fetch profile information from the authorization server and handle login/sign up normally.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;script src=&quot;https://unpkg.com/mermaid@11.12.0/dist/mermaid.min.js&quot;&gt;&lt;/script&gt;

&lt;pre class=&quot;mermaid&quot;&gt;
---
config:
  theme: &apos;neutral&apos;
  fontFamily: system-ui, -apple-system, BlinkMacSystemFont, &apos;Segoe UI&apos;, Roboto, Oxygen, Ubuntu, Cantarell, &apos;Open Sans&apos;, &apos;Helvetica Neue&apos;, sans-serif;
  nodeSpacing: 20
  rankSpacing: 25
---
sequenceDiagram
    participant Browser
    participant App as App server
    participant Auth as Auth server
    Browser-&amp;gt;&amp;gt;App: GET {app}/login-with
    App-&amp;gt;&amp;gt;Browser: 302 redirect {auth}/oauth/authorize
    Browser-&amp;gt;&amp;gt;Auth: GET {auth}/oauth/authorize
    Auth-&amp;gt;&amp;gt;Browser: Login and permissions page
    Browser-&amp;gt;&amp;gt;Auth: Log in and grant permission to app
    Auth-&amp;gt;&amp;gt;Browser: 302 redirect {app}/callback?code=...
    Browser-&amp;gt;&amp;gt;App: GET {app}/callback?code=...
    App-&amp;gt;&amp;gt;Auth: POST code to {auth}/oauth/token
    Auth-&amp;gt;&amp;gt;App: Access token
    App-&amp;gt;Auth: API calls with access token
    App-&amp;gt;&amp;gt;Browser: Logged in with auth server
&lt;/pre&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;sinatra/base&quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;oauth2&quot;&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;enable&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:sessions&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;client&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;OAuth2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;OAUTH_CLIENT_ID&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; 
  &lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;OAUTH_CLIENT_SECRET&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; 
  &lt;span class=&quot;ss&quot;&gt;site: &lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;OAUTH_SERVICE_URL&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;authorize_url: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;oauth/authorize&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# relative to service URL&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;token_url: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;oauth/token&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;         &lt;span class=&quot;c1&quot;&gt;# relative to service URL&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;redirect_uri: &lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;APP_BASE_URL&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/callback&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:logged_in&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;a href=/logout&amp;gt;log out&amp;lt;/a&amp;gt;&quot;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;a href=/login-with&amp;gt;login with&amp;lt;/a&amp;gt;&quot;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/login-with&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;redirect&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;auth_code&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;authorize_url&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Authorization server redirects here&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/callback&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;auth_code&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;params&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;code&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;access&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;auth_code&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;get_token&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;auth_code&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  
  &lt;span class=&quot;c1&quot;&gt;# make API calls with `access.token` or use `access.get/post` helpers&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:logged_in&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;redirect&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;back&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/logout&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;clear&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;redirect&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;back&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;protecting-against-redirect-csrf-with-state&quot;&gt;Protecting against redirect CSRF with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;state&lt;/code&gt;&lt;/h2&gt;

&lt;p&gt;Because the authorization code is passed as a query parameter, there’s a possibility of a &lt;a href=&quot;https://www.rfc-editor.org/rfc/rfc6819#section-4.4.1.8&quot;&gt;cross site request forgery (CSRF) attack&lt;/a&gt;. For example, the victim could click a link to the app server redirect URI but with an attacker’s authorization code and be logged in with a different account.&lt;/p&gt;

&lt;p&gt;To prevent this, we can generate a non-guessable “state” value and save it to the user’s local session cookies. Then we pass it along in a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;state&lt;/code&gt; parameter to the authorization server’s authorization endpoint.&lt;/p&gt;

&lt;p&gt;OAuth specifies query parameters must be passed along, so we verify that it matches the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;state&lt;/code&gt; on the session when redirected to our app server’s &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;redirect_uri&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;This StackExchange &lt;a href=&quot;https://security.stackexchange.com/a/278235/241664&quot;&gt;answer from Andy&lt;/a&gt; does a good job explaining the attack and mitigation.&lt;/p&gt;

&lt;h2 id=&quot;protecting-against-authorization-code-theft-with-pkce&quot;&gt;Protecting against authorization code theft with PKCE&lt;/h2&gt;

&lt;p&gt;Proof Key for Code Exchange, or PKCE (“pixy”), protects against authorization code theft and is required for OAuth 2.1. It verifies that the origin of the OAuth request is the same that uses the authorization code.&lt;/p&gt;

&lt;p&gt;To do PKCE, the app generates an unguessable code verifier, and a code challenge which is the BASE64, URL-encoded SHA-256 hash of the verifier.&lt;/p&gt;

&lt;p&gt;These are passed in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;code_challenge&lt;/code&gt; to the authorization endpoint and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;code_verifier&lt;/code&gt; to the token endpoint. The &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;code_challenge_method&lt;/code&gt; must also be passed as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;S256&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;The authorization server will verify that the code challenge and code verifier SHA-256 match before granting the access token.&lt;/p&gt;

&lt;p&gt;PKCE is also used for browser-only or mobile-only apps &lt;em&gt;without&lt;/em&gt; backends that can’t securely store OAuth client secrets. These are known as “public” &lt;a href=&quot;https://oauth.net/2/client-types/&quot;&gt;OAuth 2.0 client types&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;how-i-learned&quot;&gt;How I learned&lt;/h2&gt;

&lt;p&gt;I learned this by using the Ruby &lt;a href=&quot;https://github.com/ruby-oauth/oauth2&quot;&gt;oauth2&lt;/a&gt; gem and reading the &lt;a href=&quot;https://github.com/ruby-oauth/oauth2?tab=readme-ov-file#common-flows-end-to-end&quot;&gt;sample code&lt;/a&gt; and the Recurse Center API OAuth documentation. I used &lt;a href=&quot;https://sinatrarb.com/&quot;&gt;Sinatra&lt;/a&gt; for the backend.&lt;/p&gt;

&lt;p&gt;ChatGPT suggested &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;state&lt;/code&gt; and PKCE, which lead me to read more. PKCE is described &lt;a href=&quot;https://blog.postman.com/what-is-pkce/&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;When writing this post, I also found Aaron Parecki’s &lt;a href=&quot;https://aaronparecki.com/oauth-2-simplified/&quot;&gt;OAuth 2 Simplified blog post&lt;/a&gt; to be very clear yet concise. He also publishes a longer and more comprehensive &lt;a href=&quot;https://www.o#{auth}/&quot;&gt;microsite&lt;/a&gt;, but I rather like the blog version.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.rfc-editor.org/rfc/rfc6819#section-3.6&quot;&gt;RFC 6819&lt;/a&gt; discusses security considerations of OAuth 2.0. When researching for this post, I referenced the RFCs, linked &lt;a href=&quot;https://oauth.net/&quot;&gt;here&lt;/a&gt; (also due to Aaron Parecki).&lt;/p&gt;
</description>
        <pubDate>Mon, 17 Nov 2025 00:00:00 -0800</pubDate>
        <link>http://localhost:4000/posts/2025/11/17/til-oauth2.html</link>
        <guid isPermaLink="true">http://localhost:4000/posts/2025/11/17/til-oauth2.html</guid>
        
        
      </item>
    
  </channel>
</rss>
